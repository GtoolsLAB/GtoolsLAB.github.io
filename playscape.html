<!-- README: PlayScape - Blog/Portal de videojuegos

Arquitectura: PHP (backend) + MySQL (base de datos) + HTML/CSS/JS (frontend)
Instrucciones rápidas:
1) Importa el archivo `schema.sql` en tu servidor MySQL (por ejemplo con phpMyAdmin).
2) Coloca los archivos en un servidor con PHP 7.4+ (ej. XAMPP, LAMP, o servidor compartido).
3) Edita `includes/db.php` si quieres cambiar credenciales. Actualmente usa las credenciales que proporcionaste.
4) Asegúrate de proteger este proyecto en producción: usa HTTPS, variables de entorno, evita exponer credenciales, añade validación del lado servidor y límites de subida de archivos.

Archivos incluidos en este único documento (cópialos como archivos separados en tu proyecto):

- schema.sql
- includes/db.php
- includes/functions.php
- index.php
- register.php
- login.php
- logout.php
- create_post.php
- view_post.php
- profile.php
- admin.php
- assets/style.css
- assets/app.js

-- SCHEMA: schema.sql --
-- Copia esto en un archivo llamado schema.sql e impórtalo en tu DB

-- MySQL schema para PlayScape
CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(150) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100) DEFAULT NULL,
  bio TEXT DEFAULT NULL,
  avatar VARCHAR(255) DEFAULT NULL,
  role ENUM('lector','prensa','admin') DEFAULT 'lector',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS posts (
  id INT AUTO_INCREMENT PRIMARY KEY,
  author_id INT NOT NULL,
  title VARCHAR(255) NOT NULL,
  slug VARCHAR(255) NOT NULL UNIQUE,
  content LONGTEXT NOT NULL,
  excerpt VARCHAR(500) DEFAULT NULL,
  cover_image VARCHAR(255) DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NULL,
  FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS comments (
  id INT AUTO_INCREMENT PRIMARY KEY,
  post_id INT NOT NULL,
  user_id INT NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS ratings (
  id INT AUTO_INCREMENT PRIMARY KEY,
  post_id INT NOT NULL,
  rater_id INT NOT NULL,
  rating TINYINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (rater_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_rating (post_id, rater_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS profile_ratings (
  id INT AUTO_INCREMENT PRIMARY KEY,
  profile_id INT NOT NULL,
  rater_id INT NOT NULL,
  rating TINYINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (profile_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (rater_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_profile_rating (profile_id, rater_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- END schema.sql

-- FILE: includes/db.php --
<?php
// Configuración de la conexión a la base de datos.
// RECOMENDACIÓN: en producción guarda esto en variables de entorno en vez de en texto plano.
$DB_HOST = 'sql10.freesqldatabase.com';
$DB_NAME = 'sql10808231';
$DB_USER = 'sql10808231';
$DB_PASS = 'mq8yEKik4z';

try {
    $pdo = new PDO("mysql:host=$DB_HOST;dbname=$DB_NAME;charset=utf8mb4", $DB_USER, $DB_PASS, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ]);
} catch (PDOException $e) {
    die('DB Connection failed: ' . $e->getMessage());
}
?>

-- FILE: includes/functions.php --
<?php
require_once __DIR__ . '/db.php';
session_start();

function isLoggedIn() {
    return !empty($_SESSION['user_id']);
}

function currentUser($pdo) {
    if (!isLoggedIn()) return null;
    $stmt = $pdo->prepare('SELECT id, username, email, display_name, bio, avatar, role FROM users WHERE id = ?');
    $stmt->execute([$_SESSION['user_id']]);
    return $stmt->fetch();
}

function requireRole($roles = []) {
    if (!isLoggedIn()) {
        header('Location: login.php'); exit;
    }
    global $pdo;
    $user = currentUser($pdo);
    if (!$user || !in_array($user['role'], (array)$roles)) {
        http_response_code(403);
        echo 'Acceso denegado.'; exit;
    }
}

function slugify($text) {
    $text = preg_replace('~[^\pL0-9]+~u', '-', $text);
    $text = trim($text, '-');
    $text = iconv('utf-8', 'us-ascii//TRANSLIT', $text);
    $text = strtolower($text);
    $text = preg_replace('~[^-a-z0-9]+~', '', $text);
    if (empty($text)) return 'n-a';
    return $text . '-' . substr(sha1(mt_rand()), 0, 6);
}
?>

-- FILE: index.php --
<?php
require_once 'includes/functions.php';
// Página principal: lista de posts
$stmt = $pdo->query('SELECT p.*, u.username, u.display_name FROM posts p JOIN users u ON p.author_id = u.id ORDER BY p.created_at DESC');
$posts = $stmt->fetchAll();
$user = currentUser($pdo);
?>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PlayScape - Noticias y Blogs de Videojuegos</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body class="theme-dark">
  <header class="site-header">
    <div class="container">
      <h1 class="logo">PlayScape</h1>
      <nav>
        <a href="index.php">Inicio</a>
        <?php if (!$user): ?>
          <a href="login.php">Iniciar sesión</a>
          <a href="register.php">Registro</a>
        <?php else: ?>
          <a href="profile.php">Mi perfil</a>
          <a href="logout.php">Cerrar sesión</a>
          <?php if ($user['role'] === 'admin' || $user['role'] === 'prensa'): ?>
            <a href="create_post.php">Crear post</a>
          <?php endif; ?>
          <?php if ($user['role'] === 'admin'): ?>
            <a href="admin.php">Admin</a>
          <?php endif; ?>
        <?php endif; ?>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="posts-grid">
      <?php foreach ($posts as $p): ?>
        <article class="card">
          <?php if ($p['cover_image']): ?>
            <div class="cover"><img src="<?php echo htmlspecialchars($p['cover_image']); ?>" alt=""></div>
          <?php endif; ?>
          <h2><a href="view_post.php?slug=<?php echo urlencode($p['slug']); ?>"><?php echo htmlspecialchars($p['title']); ?></a></h2>
          <p class="meta">Por <?php echo htmlspecialchars($p['display_name'] ?: $p['username']); ?> — <?php echo htmlspecialchars($p['created_at']); ?></p>
          <p><?php echo htmlspecialchars($p['excerpt'] ?: mb_substr(strip_tags($p['content']),0,180)); ?></p>
        </article>
      <?php endforeach; ?>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">&copy; PlayScape</div>
  </footer>
  <script src="assets/app.js"></script>
</body>
</html>

-- FILE: register.php --
<?php
require_once 'includes/functions.php';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username']);
    $email = trim($_POST['email']);
    $password = $_POST['password'];

    if (!$username || !$email || !$password) {
        $error = 'Completa todos los campos.';
    } else {
        $hash = password_hash($password, PASSWORD_DEFAULT);
        $stmt = $pdo->prepare('INSERT INTO users (username, email, password_hash) VALUES (?, ?, ?)');
        try {
            $stmt->execute([$username, $email, $hash]);
            header('Location: login.php'); exit;
        } catch (PDOException $e) {
            $error = 'Error: ' . $e->getMessage();
        }
    }
}
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Registro - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="auth container">
    <h2>Registro</h2>
    <?php if (!empty($error)): ?><div class="alert"><?php echo htmlspecialchars($error); ?></div><?php endif; ?>
    <form method="post">
      <label>Usuario <input name="username"></label>
      <label>Email <input name="email" type="email"></label>
      <label>Contraseña <input name="password" type="password"></label>
      <button>Registrarse</button>
    </form>
  </main>
</body>
</html>

-- FILE: login.php --
<?php
require_once 'includes/functions.php';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email = trim($_POST['email']);
    $password = $_POST['password'];
    $stmt = $pdo->prepare('SELECT id, password_hash FROM users WHERE email = ? OR username = ? LIMIT 1');
    $stmt->execute([$email, $email]);
    $u = $stmt->fetch();
    if ($u && password_verify($password, $u['password_hash'])) {
        $_SESSION['user_id'] = $u['id'];
        header('Location: index.php'); exit;
    } else {
        $error = 'Credenciales inválidas.';
    }
}
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Login - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="auth container">
    <h2>Iniciar sesión</h2>
    <?php if (!empty($error)): ?><div class="alert"><?php echo htmlspecialchars($error); ?></div><?php endif; ?>
    <form method="post">
      <label>Email o usuario <input name="email"></label>
      <label>Contraseña <input name="password" type="password"></label>
      <button>Entrar</button>
    </form>
  </main>
</body>
</html>

-- FILE: logout.php --
<?php
require_once 'includes/functions.php';
session_destroy();
header('Location: index.php'); exit;
?>

-- FILE: create_post.php --
<?php
require_once 'includes/functions.php';
requireRole(['admin','prensa']);
$user = currentUser($pdo);
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $title = trim($_POST['title']);
    $content = $_POST['content'];
    $excerpt = mb_substr(strip_tags($content),0,250);
    $slug = slugify($title);
    $cover = null;
    // subir cover opcional (no implementado finamente)
    if (!empty($_FILES['cover']['tmp_name'])) {
        $target = 'uploads/' . basename($_FILES['cover']['name']);
        move_uploaded_file($_FILES['cover']['tmp_name'], $target);
        $cover = $target;
    }
    $stmt = $pdo->prepare('INSERT INTO posts (author_id,title,slug,content,excerpt,cover_image) VALUES (?,?,?,?,?,?)');
    $stmt->execute([$user['id'],$title,$slug,$content,$excerpt,$cover]);
    header('Location: index.php'); exit;
}
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Crear post - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="container">
    <h2>Crear post</h2>
    <form method="post" enctype="multipart/form-data">
      <label>Título <input name="title"></label>
      <label>Cover <input type="file" name="cover"></label>
      <label>Contenido <textarea name="content"></textarea></label>
      <button>Publicar</button>
    </form>
  </main>
</body>
</html>

-- FILE: view_post.php --
<?php
require_once 'includes/functions.php';
$slug = $_GET['slug'] ?? '';
$stmt = $pdo->prepare('SELECT p.*, u.username, u.display_name FROM posts p JOIN users u ON p.author_id = u.id WHERE p.slug = ? LIMIT 1');
$stmt->execute([$slug]);
$post = $stmt->fetch();
if (!$post) { echo 'Post no encontrado'; exit; }

// comentarios
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['comment'])) {
    if (!isLoggedIn()) { header('Location: login.php'); exit; }
    $content = trim($_POST['comment']);
    $stmt = $pdo->prepare('INSERT INTO comments (post_id,user_id,content) VALUES (?,?,?)');
    $stmt->execute([$post['id'], $_SESSION['user_id'], $content]);
    header('Location: view_post.php?slug=' . urlencode($slug)); exit;
}

$comments = $pdo->prepare('SELECT c.*, u.username, u.display_name FROM comments c JOIN users u ON c.user_id = u.id WHERE c.post_id = ? ORDER BY c.created_at ASC');
$comments->execute([$post['id']]);
$comments = $comments->fetchAll();

// rating post
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['rating'])) {
    if (!isLoggedIn()) { header('Location: login.php'); exit; }
    $r = (int)$_POST['rating'];
    $stmt = $pdo->prepare('INSERT INTO ratings (post_id,rater_id,rating) VALUES (?,?,?) ON DUPLICATE KEY UPDATE rating = VALUES(rating)');
    $stmt->execute([$post['id'], $_SESSION['user_id'], $r]);
    header('Location: view_post.php?slug=' . urlencode($slug)); exit;
}

// obtener rating promedio
$ravg = $pdo->prepare('SELECT AVG(rating) as avg_rating, COUNT(*) as cnt FROM ratings WHERE post_id = ?');
$ravg->execute([$post['id']]);
$ravg = $ravg->fetch();

$user = currentUser($pdo);
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title><?php echo htmlspecialchars($post['title']); ?> - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="container post-view">
    <article>
      <h1><?php echo htmlspecialchars($post['title']); ?></h1>
      <p class="meta">Por <?php echo htmlspecialchars($post['display_name'] ?: $post['username']); ?> — <?php echo $post['created_at']; ?></p>
      <?php if ($post['cover_image']): ?><img src="<?php echo htmlspecialchars($post['cover_image']); ?>" alt="cover" class="cover-large"><?php endif; ?>
      <div class="content"><?php echo $post['content']; ?></div>
      <div class="rating">Promedio: <?php echo round($ravg['avg_rating'] ?? 0,1); ?> (<?php echo $ravg['cnt']; ?>)</div>

      <?php if ($user): ?>
        <form method="post" class="rate-form">
          <label>Calificar: 
            <select name="rating">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </label>
          <button>Enviar</button>
        </form>
      <?php else: ?>
        <p><a href="login.php">Inicia sesión</a> para calificar o comentar.</p>
      <?php endif; ?>

      <section class="comments">
        <h3>Comentarios</h3>
        <?php foreach ($comments as $c): ?>
          <div class="comment"><strong><?php echo htmlspecialchars($c['display_name'] ?: $c['username']); ?></strong> <span class="time"><?php echo $c['created_at']; ?></span>
            <p><?php echo htmlspecialchars($c['content']); ?></p>
          </div>
        <?php endforeach; ?>

        <?php if ($user): ?>
          <form method="post">
            <textarea name="comment" placeholder="Escribe tu comentario..."></textarea>
            <button>Comentar</button>
          </form>
        <?php endif; ?>
      </section>
    </article>
  </main>
</body>
</html>

-- FILE: profile.php --
<?php
require_once 'includes/functions.php';
$user = currentUser($pdo);
if (!$user) { header('Location: login.php'); exit; }

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $display_name = trim($_POST['display_name']);
    $bio = trim($_POST['bio']);
    // avatar upload simple
    $avatar = $user['avatar'];
    if (!empty($_FILES['avatar']['tmp_name'])) {
        $t = 'uploads/avatars_' . time() . '_' . basename($_FILES['avatar']['name']);
        move_uploaded_file($_FILES['avatar']['tmp_name'], $t);
        $avatar = $t;
    }
    $stmt = $pdo->prepare('UPDATE users SET display_name = ?, bio = ?, avatar = ? WHERE id = ?');
    $stmt->execute([$display_name, $bio, $avatar, $user['id']]);
    header('Location: profile.php'); exit;
}

// profile ratings
$pr = $pdo->prepare('SELECT AVG(rating) as avg, COUNT(*) as cnt FROM profile_ratings WHERE profile_id = ?');
$pr->execute([$user['id']]); $pr = $pr->fetch();
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Mi perfil - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="container">
    <h2>Mi perfil</h2>
    <div class="profile">
      <img src="<?php echo htmlspecialchars($user['avatar'] ?? 'assets/default-avatar.png'); ?>" class="avatar">
      <form method="post" enctype="multipart/form-data">
        <label>Nombre visible <input name="display_name" value="<?php echo htmlspecialchars($user['display_name']); ?>"></label>
        <label>Bio <textarea name="bio"><?php echo htmlspecialchars($user['bio']); ?></textarea></label>
        <label>Avatar <input type="file" name="avatar"></label>
        <button>Actualizar</button>
      </form>
      <div class="profile-stats">Puntuación promedio: <?php echo round($pr['avg'] ?? 0,1); ?> (<?php echo $pr['cnt']; ?>)</div>
    </div>
  </main>
</body>
</html>

-- FILE: admin.php --
<?php
require_once 'includes/functions.php';
requireRole(['admin']);
$user = currentUser($pdo);
// lista de usuarios para cambiar roles
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['role_user_id'])) {
    $rid = (int)$_POST['role_user_id'];
    $newrole = $_POST['role'];
    $stmt = $pdo->prepare('UPDATE users SET role = ? WHERE id = ?');
    $stmt->execute([$newrole, $rid]);
}
$users = $pdo->query('SELECT id, username, email, role, display_name FROM users ORDER BY id DESC')->fetchAll();
?>
<!doctype html>
<html lang="es">
<head><meta charset="utf-8"><title>Admin - PlayScape</title><link rel="stylesheet" href="assets/style.css"></head>
<body class="theme-dark">
  <main class="container">
    <h2>Panel Admin</h2>
    <table class="admin-table">
      <thead><tr><th>ID</th><th>Usuario</th><th>Email</th><th>Role</th><th>Acción</th></tr></thead>
      <tbody>
        <?php foreach ($users as $u): ?>
          <tr>
            <td><?php echo $u['id']; ?></td>
            <td><?php echo htmlspecialchars($u['display_name'] ?: $u['username']); ?></td>
            <td><?php echo htmlspecialchars($u['email']); ?></td>
            <td><?php echo $u['role']; ?></td>
            <td>
              <form method="post" style="display:inline-block">
                <input type="hidden" name="role_user_id" value="<?php echo $u['id']; ?>">
                <select name="role">
                  <option value="lector">lector</option>
                  <option value="prensa">prensa</option>
                  <option value="admin">admin</option>
                </select>
                <button>Cambiar</button>
              </form>
            </td>
          </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </main>
</body>
</html>

-- FILE: assets/style.css --
/* Estilo principal: tonalidades rojas y negras, diseño moderno */
:root{
  --bg:#0b0b0b;
  --card:#121212;
  --accent:#d32f2f;
  --accent-2:#9b111e;
  --text:#eaeaea;
}
*{box-sizing:border-box}
body.theme-dark{background:linear-gradient(180deg,#070707 0%,#0f0f0f 100%);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif;margin:0}
.container{max-width:1000px;margin:0 auto;padding:20px}
.site-header{background:linear-gradient(90deg,rgba(0,0,0,0.6), rgba(20,0,0,0.2));border-bottom:1px solid rgba(255,255,255,0.03)}
.site-header .container{display:flex;align-items:center;justify-content:space-between}
.logo{font-size:1.6rem;color:var(--accent);margin:0}
nav a{color:var(--text);margin-left:14px;text-decoration:none}
.posts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-top:20px}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
.card h2{margin:0 0 10px}
.meta{font-size:0.85rem;color:rgba(255,255,255,0.6)}
.cover img{width:100%;height:150px;object-fit:cover;border-radius:8px}
.auth{max-width:420px;margin:60px auto}
.auth form label{display:block;margin-bottom:12px}
.auth input, .auth textarea, select{width:100%;padding:10px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.06);color:var(--text);border-radius:6px}
button{background:var(--accent);border:0;padding:10px 14px;border-radius:8px;color:white;cursor:pointer}
.site-footer{padding:20px;text-align:center;color:rgba(255,255,255,0.5)}
.post-view .cover-large{width:100%;max-height:420px;object-fit:cover;border-radius:8px}
.profile{display:flex;gap:20px;align-items:flex-start}
.avatar{width:120px;height:120px;object-fit:cover;border-radius:8px}
.admin-table{width:100%;border-collapse:collapse}
.admin-table th, .admin-table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.alert{background:rgba(211,47,47,0.12);padding:10px;border-left:4px solid var(--accent)}

-- FILE: assets/app.js --
// Pequeñas mejoras de UX
document.addEventListener('click', e => {
  if (e.target.matches('.card a')) {
    // interacción futura
  }
});

// TODO: añadir validaciones frontend, editor WYSIWYG para contenidos, carga segura de archivos

-- END OF PROJECT --
